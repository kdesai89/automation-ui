name: UI Tests

on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *" # daily (UTC)

jobs:
  ui:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ui-tests:latest .

      # Optional but VERY useful: fail fast if site is blocked from GitHub runners
      - name: Check site accessibility
        id: sitecheck
        run: |
          set +e
          URL="https://iq4.rainbird.com"
          echo "Checking: $URL"
          curl -I --max-time 20 "$URL"
          RC=$?
          if [ $RC -ne 0 ]; then
            echo "reachable=false" >> $GITHUB_OUTPUT
            echo "Site not reachable from this runner (curl exit code $RC)."
          else
            echo "reachable=true" >> $GITHUB_OUTPUT
            echo "Site reachable from this runner."
          fi

      - name: Run Smoke tests
        if: steps.sitecheck.outputs.reachable == 'true'
        run: |
          mkdir -p reports
          docker run --rm \
            -e ENV=qa \
            -e HEADLESS=true \
            -e CI=true \
            -v "${{ github.workspace }}/reports:/app/reports" \
            ui-tests:latest \
            pytest -c tests/pytest.ini --env qa -m smoke \
              --junitxml=reports/junit.xml \
              --alluredir=reports/allure-results

      # If blocked, still produce an artifact explaining why
      - name: Write skip reason (site blocked)
        if: steps.sitecheck.outputs.reachable != 'true'
        run: |
          mkdir -p reports
          echo "UI tests were skipped because the site was not reachable from GitHub-hosted runner IPs." > reports/SKIPPED.txt
          echo "Use a self-hosted runner (VM on VPN/internal network) if this is an internal/staging site." >> reports/SKIPPED.txt

      # Install Java (required by Allure CLI)
      - name: Setup Java
        if: always()
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Install Allure CLI on the runner
      - name: Install Allure CLI
        if: always()
        run: |
          set -e
          ALLURE_VERSION="2.27.0"
          curl -L -o allure.tgz "https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.tgz"
          tar -xzf allure.tgz
          echo "${{ github.workspace }}/allure-${ALLURE_VERSION}/bin" >> $GITHUB_PATH
          allure --version

      - name: Generate Allure HTML
        if: always()
        run: |
          if [ -d "reports/allure-results" ] && [ "$(ls -A reports/allure-results 2>/dev/null)" ]; then
            allure generate reports/allure-results --clean -o reports/allure-report
            echo "Allure report generated under reports/allure-report"
          else
            echo "No allure-results found. Skipping Allure HTML generation."
          fi

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-reports
          path: reports/
